<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocuMed - Sistema M√©dico Inteligente</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #667eea;
            --primary-dark: #482d97;
            --secondary: #764ba2;
            --danger: #dc3545;
            --warning: #ffc107;
            --success: #28a745;
            --info: #17a2b8;
            --dark: #343a40;
            --light: #f8f9fa;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8eaed 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #e8eaed 0%, #d4d7dc 100%);
            color: #2c3e50;
            padding: 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 4px solid #c4c7cc;
        }
        
        .header h1 {
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-icon {
            font-size: 32px;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
        }
        
        /* Professional Header Styles */
        .professional-header {
            background: linear-gradient(135deg, #e8eaed 0%, #d4d7dc 100%);
            color: #2c3e50;
            padding: 20px 40px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-bottom: 3px solid #c4c7cc;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15));
        }
        
        .brand-text {
            display: flex;
            flex-direction: column;
        }
        
        .brand-name {
            font-size: 28px;
            font-weight: bold;
            letter-spacing: 1px;
        }
        
        .brand-subtitle {
            font-size: 12px;
            opacity: 0.9;
            font-weight: 300;
        }
        
        .header-status {
            display: flex;
            align-items: center;
        }
        
        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            background: #00ff00;
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }
        
        .status-text {
            color: white;
        }
        
        .dot {
            width: 10px;
            height: 10px;
            background: #00ff00;
            border-radius: 50%;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            50% { opacity: 0.5; }
        }
        
        .content {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 20px;
            padding: 25px;
            min-height: 600px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .panel {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,102,204,0.08);
        }
        
        .panel-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }
        
        .search-box {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .search-box input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .search-box button {
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }
        
        .search-box button:hover {
            background: #0052a3;
        }
        
        .patient-item {
            padding: 10px;
            margin: 8px 0;
            background: var(--light);
            border-left: 4px solid var(--primary);
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .patient-item:hover {
            background: #e7f0ff;
            transform: translateX(5px);
        }
        
        .patient-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--dark);
        }
        
        .patient-info {
            font-size: 12px;
            color: #666;
            margin-top: 3px;
        }
        
        .alert-item {
            padding: 12px;
            margin: 8px 0;
            border-radius: 5px;
            font-size: 13px;
            display: flex;
            gap: 10px;
        }
        
        .alert-critical {
            background: linear-gradient(135deg, #ffe1e1 0%, #ffcccc 100%);
            border-left: 5px solid #dc3545;
            color: #721c24;
            font-weight: 500;
        }
        
        .alert-high {
            background: linear-gradient(135deg, #fff3cd 0%, #ffe8b6 100%);
            border-left: 5px solid #ffc107;
            color: #856404;
            font-weight: 500;
        }
        
        .alert-moderate {
            background: linear-gradient(135deg, #d1ecf1 0%, #c3e4eb 100%);
            border-left: 5px solid #17a2b8;
            color: #0c5460;
            font-weight: 500;
        }
        
        .alert-normal {
            background: linear-gradient(135deg, #e8d5f0 0%, #dbc4e8 100%);
            border-left: 5px solid #764ba2;
            color: #4a2e5f;
            font-weight: 500;
        }
        
        .profile-info {
            display: grid;
            gap: 10px;
        }
        
        .info-row {
            padding: 8px;
            background: var(--light);
            border-radius: 5px;
        }
        
        .info-label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
        }
        
        .info-value {
            font-size: 14px;
            color: var(--dark);
            margin-top: 3px;
        }
        
        .lab-form {
            display: grid;
            gap: 10px;
        }
        
        .form-group {
            display: grid;
            gap: 5px;
        }
        
        .form-label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
        }
        
        .form-input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, #3d2270 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.35);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--secondary) 0%, #5a3a78 100%);
            color: white;
            border: none;
            font-weight: 600;
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #5a3a78 0%, #462d5a 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(118, 75, 162, 0.35);
        }
        
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            gap: 10px;
        }
        
        .chat-messages {
            flex: 1;
            background: var(--light);
            border-radius: 5px;
            padding: 12px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 400px;
        }
        
        .message {
            padding: 10px;
            border-radius: 5px;
            font-size: 13px;
            max-width: 90%;
            word-wrap: break-word;
        }
        
        .message.ai {
            background: #e3f2fd;
            color: #0066cc;
            border-left: 3px solid #0066cc;
            align-self: flex-start;
        }
        
        .message.user {
            background: #c8e6c9;
            color: #2e7d32;
            border-left: 3px solid #2e7d32;
            align-self: flex-end;
        }
        
        .chat-input {
            display: flex;
            gap: 8px;
        }
        
        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 13px;
        }
        
        .chat-input button {
            padding: 10px 15px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .chat-input button:hover {
            background: #218838;
        }
        
        .results-section {
            margin-top: 20px;
            padding: 15px;
            background: var(--light);
            border-radius: 8px;
        }
        
        .result-item {
            padding: 10px;
            background: white;
            border-left: 4px solid var(--warning);
            margin: 8px 0;
            border-radius: 3px;
            font-size: 13px;
        }
        
        .result-item.critical {
            border-left-color: var(--danger);
            background: #ffe1e1;
        }
        
        .result-item.high {
            border-left-color: var(--warning);
            background: #fff3cd;
        }
        
        .result-item.moderate {
            border-left-color: #fbc02d;
            background: #fffde7;
        }
        
        .loading {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #666;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1); }
        }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin: 2px;
        }
        
        .badge-critical { background: #dc3545; color: white; }
        .badge-high { background: #ffc107; color: black; }
        .badge-moderate { background: #17a2b8; color: white; }
        .badge-normal { background: #28a745; color: white; }
        
        .summary-box {
            background: #f0f7ff;
            border-left: 4px solid var(--primary);
            padding: 15px;
            border-radius: 5px;
            font-size: 13px;
            line-height: 1.6;
            color: var(--dark);
        }
        
        @media (max-width: 1200px) {
            .content {
                grid-template-columns: 1fr;
            }
        }
        
        .error {
            background: #ffe1e1;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #dc3545;
            font-size: 13px;
        }
        
        .success {
            background: #d1e7dd;
            color: #0f5132;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #28a745;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <!-- Professional Header with Logo -->
    <header class="professional-header">
        <div class="header-content">
            <div class="logo-section">
                <img src="/img/hvirfill logo.jpg" alt="DocuMed Logo" class="logo">
                <div class="brand-text">
                    <div class="brand-name">DocuMed</div>
                    <div class="brand-subtitle">Sistema M√©dico Inteligente</div>
                </div>
            </div>
            <div class="header-status">
                <div class="status-badge">
                    <span class="status-dot"></span>
                    <span class="status-text">Sistema Online</span>
                </div>
            </div>
        </div>
    </header>
    
    <div class="container">
        <!-- Main Content -->
        
        <!-- Contenido Principal -->
        <div class="content">
            <!-- Panel Izquierdo: B√∫squeda y Alertas -->
            <div>
                <!-- B√∫squeda de Pacientes -->
                <div class="panel">
                    <div class="panel-title">üîç Buscar Paciente</div>
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="Nombre o c√©dula...">
                        <button onclick="buscarPaciente()">Buscar</button>
                    </div>
                    <div id="searchResults"></div>
                </div>
                
                <!-- Alertas Activas -->
                <div class="panel" style="margin-top: 20px;">
                    <div class="panel-title">‚ö†Ô∏è Alertas Cr√≠ticas</div>
                    <div id="alertasPanel">
                        <p style="color: #666; font-size: 13px;">Sin alertas activas</p>
                    </div>
                </div>
            </div>
            
            <!-- Panel Central: Perfil y An√°lisis -->
            <div>
                <!-- Perfil del Paciente -->
                <div class="panel">
                    <div class="panel-title">üë§ Perfil del Paciente</div>
                    <div id="perfilPaciente">
                        <p style="color: #999; font-size: 13px; text-align: center;">Selecciona un paciente</p>
                    </div>
                </div>
                
                <!-- An√°lisis de Laboratorio -->
                <div class="panel" style="margin-top: 20px;">
                    <div class="panel-title">üß™ An√°lisis de Laboratorio Completo</div>
                    <div class="lab-form" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <!-- Hemograma -->
                        <div>
                            <h4 style="margin: 10px 0 5px 0; font-size: 12px; color: #666; border-bottom: 1px solid #ddd; padding-bottom: 5px;">Hemograma</h4>
                            <div class="form-group">
                                <label class="form-label">Glucosa (mg/dL) <span style="font-size: 10px;">N: 70-100</span></label>
                                <input type="number" id="glucosa" class="form-input" placeholder="Ej: 95" step="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Hemoglobina (g/dL) <span style="font-size: 10px;">N: 12-17.5</span></label>
                                <input type="number" id="hemoglobina" class="form-input" placeholder="Ej: 14.5" step="0.1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Hematocrito (%) <span style="font-size: 10px;">N: 36-46</span></label>
                                <input type="number" id="hematocrito" class="form-input" placeholder="Ej: 42" step="1">
                            </div>
                        </div>
                        
                        <!-- Funci√≥n renal y electrolitos -->
                        <div>
                            <h4 style="margin: 10px 0 5px 0; font-size: 12px; color: #666; border-bottom: 1px solid #ddd; padding-bottom: 5px;">Funci√≥n Renal</h4>
                            <div class="form-group">
                                <label class="form-label">Creatinina (mg/dL) <span style="font-size: 10px;">N: 0.7-1.3</span></label>
                                <input type="number" id="creatinina" class="form-input" placeholder="Ej: 1.0" step="0.1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Sodio (mEq/L) <span style="font-size: 10px;">N: 136-145</span></label>
                                <input type="number" id="sodio" class="form-input" placeholder="Ej: 140" step="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Potasio (mEq/L) <span style="font-size: 10px;">N: 3.5-5</span></label>
                                <input type="number" id="potasio" class="form-input" placeholder="Ej: 4.2" step="0.1">
                            </div>
                        </div>
                        
                        <!-- Presi√≥n arterial -->
                        <div>
                            <h4 style="margin: 10px 0 5px 0; font-size: 12px; color: #666; border-bottom: 1px solid #ddd; padding-bottom: 5px;">Presi√≥n Arterial</h4>
                            <div class="form-group">
                                <label class="form-label">P. Sist√≥lica (mmHg) <span style="font-size: 10px;">N: 90-120</span></label>
                                <input type="number" id="presion_sistolica" class="form-input" placeholder="Ej: 110" step="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">P. Diast√≥lica (mmHg) <span style="font-size: 10px;">N: 60-80</span></label>
                                <input type="number" id="presion_diastolica" class="form-input" placeholder="Ej: 70" step="1">
                            </div>
                        </div>
                        
                        <!-- Perfil lip√≠dico -->
                        <div>
                            <h4 style="margin: 10px 0 5px 0; font-size: 12px; color: #666; border-bottom: 1px solid #ddd; padding-bottom: 5px;">Perfil Lip√≠dico</h4>
                            <div class="form-group">
                                <label class="form-label">Colesterol Total (mg/dL) <span style="font-size: 10px;">N: <200</span></label>
                                <input type="number" id="colesterol_total" class="form-input" placeholder="Ej: 180" step="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Triglic√©ridos (mg/dL) <span style="font-size: 10px;">N: <150</span></label>
                                <input type="number" id="trigliceridos" class="form-input" placeholder="Ej: 120" step="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">HDL (mg/dL) <span style="font-size: 10px;">N: >40</span></label>
                                <input type="number" id="hdl" class="form-input" placeholder="Ej: 50" step="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">LDL (mg/dL) <span style="font-size: 10px;">N: <100</span></label>
                                <input type="number" id="ldl" class="form-input" placeholder="Ej: 90" step="1">
                            </div>
                        </div>
                        
                        <!-- Funci√≥n hep√°tica -->
                        <div>
                            <h4 style="margin: 10px 0 5px 0; font-size: 12px; color: #666; border-bottom: 1px solid #ddd; padding-bottom: 5px;">Funci√≥n Hep√°tica</h4>
                            <div class="form-group">
                                <label class="form-label">Bilirrubina (mg/dL) <span style="font-size: 10px;">N: 0.2-1.3</span></label>
                                <input type="number" id="bilirrubina" class="form-input" placeholder="Ej: 0.8" step="0.1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">AST (U/L) <span style="font-size: 10px;">N: 10-40</span></label>
                                <input type="number" id="ast" class="form-input" placeholder="Ej: 30" step="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ALT (U/L) <span style="font-size: 10px;">N: 7-56</span></label>
                                <input type="number" id="alt" class="form-input" placeholder="Ej: 28" step="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Alb√∫mina (g/dL) <span style="font-size: 10px;">N: 3.5-5</span></label>
                                <input type="number" id="albumina" class="form-input" placeholder="Ej: 4.2" step="0.1">
                            </div>
                        </div>
                        
                        <!-- Minerales -->
                        <div>
                            <h4 style="margin: 10px 0 5px 0; font-size: 12px; color: #666; border-bottom: 1px solid #ddd; padding-bottom: 5px;">Minerales</h4>
                            <div class="form-group">
                                <label class="form-label">Calcio (mg/dL) <span style="font-size: 10px;">N: 8.5-10.2</span></label>
                                <input type="number" id="calcio" class="form-input" placeholder="Ej: 9.2" step="0.1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">F√≥sforo (mg/dL) <span style="font-size: 10px;">N: 2.5-4.5</span></label>
                                <input type="number" id="fosforo" class="form-input" placeholder="Ej: 3.5" step="0.1">
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="analizarLaboratorio()" style="width: 100%; margin-top: 15px; padding: 12px;">
                        üìä Analizar Resultados Completos
                    </button>
                    <div id="laboratorioResultados"></div>
                </div>
            </div>
            
            <!-- Panel Derecho: Chat con annIA -->
            <div>
                <div class="panel" style="height: 100%; display: flex; flex-direction: column;">
                    <div class="panel-title">üí¨ annIA - Consulta M√©dica</div>
                    <div class="chat-container">
                        <div class="chat-messages" id="chatMessages">
                            <div class="message ai">
                                Hola, soy <strong>annIA</strong>. Estoy aqu√≠ para ayudarte con an√°lisis cl√≠nicos. ¬øTienes alguna pregunta m√©dica?
                            </div>
                        </div>
                        <div class="chat-input">
                            <input type="text" id="chatInput" placeholder="Escribe tu pregunta..." onkeypress="if(event.key==='Enter') enviarConsulta()">
                            <button onclick="enviarConsulta()">Enviar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = 'http://localhost:5000';
        let pacienteActual = null;
        
        // Buscar Paciente
        async function buscarPaciente() {
            const valor = document.getElementById('searchInput').value;
            if (!valor) {
                alert('Ingresa un nombre o c√©dula');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/medical/buscar-paciente`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ criterio: 'nombre', valor: valor })
                });
                
                const data = await response.json();
                console.log('Respuesta b√∫squeda:', data);
                
                if (!data.exito || !data.resultado) {
                    throw new Error(data.error || 'No se encontraron pacientes');
                }
                
                mostrarResultadosBusqueda(data.resultado.resultados);
            } catch (e) {
                document.getElementById('searchResults').innerHTML = 
                    `<div class="error">Error: ${e.message}</div>`;
            }
        }
        
        function mostrarResultadosBusqueda(pacientes) {
            if (!pacientes || pacientes.length === 0) {
                document.getElementById('searchResults').innerHTML = 
                    '<p style="color: #999; font-size: 13px;">No se encontraron pacientes</p>';
                return;
            }
            
            const html = pacientes.map(p => `
                <div class="patient-item" onclick="seleccionarPaciente('${p.id}')">
                    <div class="patient-name">${p.nombre} ${p.apellido}</div>
                    <div class="patient-info">ID: ${p.id} | C√©dula: ${p.cedula}</div>
                </div>
            `).join('');
            
            document.getElementById('searchResults').innerHTML = html;
        }
        
        async function seleccionarPaciente(pacienteId) {
            pacienteActual = pacienteId;
            
            try {
                const response = await fetch(`${API_URL}/api/medical/perfil-paciente/${pacienteId}`);
                const data = await response.json();
                mostrarPerfilPaciente(data.perfil);
                obtenerAlertas(pacienteId);
            } catch (e) {
                console.error('Error:', e);
            }
        }
        
        function mostrarPerfilPaciente(perfil) {
            const info = perfil.informaci√≥n_personal;
            const antec = perfil.antecedentes;
            
            const html = `
                <div class="profile-info">
                    <div class="info-row">
                        <div class="info-label">Nombre</div>
                        <div class="info-value">${info.nombre} ${info.apellido}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">C√©dula</div>
                        <div class="info-value">${info.cedula}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Edad</div>
                        <div class="info-value">${info.edad} a√±os</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Diagn√≥sticos</div>
                        <div class="info-value">${antec.diagn√≥sticos.join(', ') || 'Ninguno'}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Medicamentos</div>
                        <div class="info-value">${antec.medicamentos.join(', ') || 'Ninguno'}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Alergias</div>
                        <div class="info-value">${antec.alergias.join && antec.alergias.join(', ') || antec.alergias || 'Ninguna'}</div>
                    </div>
                </div>
            `;
            
            document.getElementById('perfilPaciente').innerHTML = html;
        }
        
        async function obtenerAlertas(pacienteId) {
            try {
                const response = await fetch(`${API_URL}/api/medical/alertas/${pacienteId}?solo_activas=true`);
                const data = await response.json();
                mostrarAlertas(data.alertas.alertas);
            } catch (e) {
                console.error('Error:', e);
            }
        }
        
        function mostrarAlertas(alertas) {
            if (!alertas || alertas.length === 0) {
                document.getElementById('alertasPanel').innerHTML = 
                    '<p style="color: #666; font-size: 13px;">Sin alertas cr√≠ticas</p>';
                return;
            }
            
            const html = alertas.map(a => {
                const clase = a.severidad === 'CR√çTICO' ? 'alert-critical' : 
                              a.severidad === 'ALTO' ? 'alert-high' : 'alert-moderate';
                
                const msg = a.mensaje || a.prueba || a.descripci√≥n || 'Sin descripci√≥n';
                
                return `<div class="alert-item ${clase}">${a.s√≠mbolo} ${msg}</div>`;
            }).join('');
            
            document.getElementById('alertasPanel').innerHTML = html;
        }
        
        async function analizarLaboratorio() {
            if (!pacienteActual) {
                alert('Selecciona un paciente primero');
                return;
            }
            
            // Recolectar todos los valores (solo los que no est√©n vac√≠os)
            const campos = [
                'glucosa', 'hemoglobina', 'hematocrito', 'creatinina', 'sodio', 'potasio',
                'presion_sistolica', 'presion_diastolica', 'colesterol_total', 'trigliceridos',
                'hdl', 'ldl', 'bilirrubina', 'ast', 'alt', 'albumina', 'calcio', 'fosforo'
            ];
            
            const resultados = {};
            for (let campo of campos) {
                const valor = document.getElementById(campo)?.value;
                if (valor && valor.trim() !== '') {
                    resultados[campo] = parseFloat(valor);
                }
            }
            
            // Validar que hay al menos un resultado
            if (Object.keys(resultados).length === 0) {
                document.getElementById('laboratorioResultados').innerHTML = 
                    `<div class="error">‚ö† Error: Ingresa al menos un valor de laboratorio</div>`;
                return;
            }
            
            // Validar que son n√∫meros v√°lidos
            for (let [campo, valor] of Object.entries(resultados)) {
                if (isNaN(valor)) {
                    document.getElementById('laboratorioResultados').innerHTML = 
                        `<div class="error">‚ö† Error: ${campo} debe ser un n√∫mero v√°lido</div>`;
                    return;
                }
            }
            
            try {
                const response = await fetch(`${API_URL}/api/medical/analizar-laboratorio`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ paciente_id: pacienteActual, resultados: resultados })
                });
                
                const data = await response.json();
                console.log('Respuesta an√°lisis:', data);
                
                if (!data.exito || !data.an√°lisis) {
                    throw new Error(data.error || 'Respuesta inv√°lida del servidor');
                }
                
                mostrarResultadosLaboratorio(data.an√°lisis);
                
                // Limpiar campos
                for (let campo of campos) {
                    document.getElementById(campo).value = '';
                }
                
            } catch (e) {
                console.error('Error:', e);
                document.getElementById('laboratorioResultados').innerHTML = 
                    `<div class="error">Error: ${e.message}</div>`;
            }
        }
        
        function mostrarResultadosLaboratorio(an√°lisis) {
            if (!an√°lisis || !an√°lisis.anomal√≠as) {
                document.getElementById('laboratorioResultados').innerHTML = 
                    `<div class="success">‚úì An√°lisis normal. No hay anomal√≠as detectadas.</div>`;
                return;
            }
            
            // Separar por severidad
            const criticons = an√°lisis.anomal√≠as.filter(a => a.estado === 'CR√çTICO');
            const altos = an√°lisis.anomal√≠as.filter(a => a.estado === 'ALTO');
            const moderados = an√°lisis.anomal√≠as.filter(a => a.estado === 'MODERADO');
            
            let html = '<div class="results-section">';
            
            if (criticons.length > 0) {
                html += '<div style="margin-bottom: 10px;"><strong style="color: #d32f2f;">üî¥ CR√çTICO (' + criticons.length + '):</strong>';
                for (let a of criticons) {
                    html += `<div class="result-item critical" style="margin-top: 5px;">
                        <strong>${a.prueba}</strong>: <span style="font-weight: bold; color: #d32f2f;">${a.valor}</span><br>
                        <small>${a.recomendaci√≥n}</small>
                    </div>`;
                }
                html += '</div>';
            }
            
            if (altos.length > 0) {
                html += '<div style="margin-bottom: 10px;"><strong style="color: #f57c00;">üü† ALTO (' + altos.length + '):</strong>';
                for (let a of altos) {
                    html += `<div class="result-item high" style="margin-top: 5px;">
                        <strong>${a.prueba}</strong>: <span style="font-weight: bold; color: #f57c00;">${a.valor}</span><br>
                        <small>${a.recomendaci√≥n}</small>
                    </div>`;
                }
                html += '</div>';
            }
            
            if (moderados.length > 0) {
                html += '<div style="margin-bottom: 10px;"><strong style="color: #fbc02d;">üü° MODERADO (' + moderados.length + '):</strong>';
                for (let a of moderados) {
                    html += `<div class="result-item moderate" style="margin-top: 5px;">
                        <strong>${a.prueba}</strong>: <span style="font-weight: bold; color: #fbc02d;">${a.valor}</span><br>
                        <small>${a.recomendaci√≥n}</small>
                    </div>`;
                }
                html += '</div>';
            }
            
            html += '<div class="success" style="margin-top: 15px;">';
            html += `‚úì An√°lisis guardado. <strong>${an√°lisis.alertas_generadas ? an√°lisis.alertas_generadas.length : 0} alerta(s)</strong> generada(s).<br>`;
            html += `Total de pruebas analizadas: ${an√°lisis.resultados_analizados.length}`;
            html += '</div></div>';
            
            document.getElementById('laboratorioResultados').innerHTML = html;
            obtenerAlertas(pacienteActual);
        }
        
        async function enviarConsulta() {
            const pregunta = document.getElementById('chatInput').value;
            if (!pregunta) return;
            
            // Mostrar pregunta del usuario
            agregarMensaje(pregunta, 'user');
            document.getElementById('chatInput').value = '';
            
            // Mostrar loading
            const msgLoading = agregarMensaje('anIA est√° procesando...', 'ai');
            
            try {
                // Construir contexto con paciente actual
                let contexto = '';
                if (pacienteActual) {
                    contexto = `Paciente actual seleccionado: ${pacienteActual}`;
                }
                
                // Buscar si se menciona alg√∫n paciente en la pregunta
                const palabrasClave = pregunta.toLowerCase();
                const pacientesConocidos = ['juan', 'maria', 'carlos', 'ana', 'roberto', 'garcia', 'lopez', 'rodriguez', 'martinez', 'fernandez'];
                
                for (let paciente of pacientesConocidos) {
                    if (palabrasClave.includes(paciente)) {
                        // Buscar este paciente
                        const searchResponse = await fetch(`${API_URL}/api/medical/buscar-paciente`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ criterio: 'nombre', valor: paciente })
                        });
                        
                        const searchData = await searchResponse.json();
                        if (searchData.exito && searchData.resultado && searchData.resultado.resultados.length > 0) {
                            const pacEncontrado = searchData.resultado.resultados[0];
                            
                            // Obtener perfil completo
                            const perfilResponse = await fetch(`${API_URL}/api/medical/perfil-paciente/${pacEncontrado.id}`);
                            const perfilData = await perfilResponse.json();
                            
                            if (perfilData.exito && perfilData.perfil) {
                                const perfil = perfilData.perfil;
                                const info = perfil.informaci√≥n_personal;
                                const antec = perfil.antecedentes || {};
                                
                                // Construir contexto del paciente
                                let diagn√≥sticos = (antec.diagn√≥sticos || []).join(', ') || 'Ninguno registrado';
                                let medicamentos = (antec.medicamentos || []).join(', ') || 'Ninguno registrado';
                                let alergias = info.alergias || 'Ninguna registrada';
                                
                                contexto += `\n\nPACIENTE MENCIONADO - ${info.nombre} ${info.apellido}:
- Edad: ${info.edad} a√±os, G√©nero: ${info.g√©nero}
- C√©dula: ${info.cedula}
- Diagn√≥sticos: ${diagn√≥sticos}
- Medicamentos: ${medicamentos}
- Alergias: ${alergias}`;
                            }
                        }
                        break;
                    }
                }
                
                const response = await fetch(`${API_URL}/api/medical/consultar-groq`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ consulta: pregunta, contexto: contexto })
                });
                
                const data = await response.json();
                console.log('Respuesta Groq:', data);
                
                // Remover mensaje de loading
                const msgs = document.getElementById('chatMessages');
                if (msgs.lastChild) {
                    msgs.removeChild(msgs.lastChild);
                }
                
                // Validar estructura de respuesta
                if (!data.exito) {
                    agregarMensaje('Error del servidor: ' + (data.error || 'Error desconocido'), 'ai');
                    return;
                }
                
                // Acceder correctamente a la respuesta
                const respuestaTexto = data.respuesta && data.respuesta.respuesta 
                    ? data.respuesta.respuesta 
                    : (data.respuesta || 'Sin respuesta');
                
                // Mostrar respuesta
                agregarMensaje(respuestaTexto, 'ai');
            } catch (e) {
                const msgs = document.getElementById('chatMessages');
                if (msgs.lastChild) {
                    msgs.removeChild(msgs.lastChild);
                }
                console.error('Error en chat:', e);
                agregarMensaje('Error de conexi√≥n: ' + e.message, 'ai');
            }
        }
        
        function agregarMensaje(texto, tipo) {
            const msg = document.createElement('div');
            msg.className = `message ${tipo}`;
            msg.textContent = texto;
            
            const container = document.getElementById('chatMessages');
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }
    </script>
</body>
</html>
